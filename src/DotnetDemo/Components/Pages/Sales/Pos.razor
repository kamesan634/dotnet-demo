@page "/pos"
@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using DotnetDemo.Data
@using DotnetDemo.Services.Interfaces
@inject ApplicationDbContext DbContext
@inject IOrderService OrderService
@inject IProductService ProductService
@inject ICustomerService CustomerService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar

<PageTitle>POS 銷售 - 零售管理系統</PageTitle>

<MudGrid>
    <MudItem xs="12" md="8">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">商品搜尋</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudAutocomplete T="Product" Label="搜尋商品 (名稱/條碼)" @bind-Value="_selectedProduct"
                                 SearchFunc="SearchProducts" ToStringFunc="@(p => p?.Name ?? "")"
                                 Variant="Variant.Outlined" Clearable="true"
                                 AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor="Color.Primary" />

                @if (_selectedProduct != null)
                {
                    <MudGrid Class="mt-4">
                        <MudItem xs="6">
                            <MudNumericField @bind-Value="_quantity" Label="數量" Min="1" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                                       OnClick="AddToCart" Class="mt-2" Size="Size.Large">
                                加入購物車
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                }

                <MudDivider Class="my-4" />

                <MudTable Items="@_cartItems" Dense="true" Hover="true">
                    <HeaderContent>
                        <MudTh>商品</MudTh>
                        <MudTh>單價</MudTh>
                        <MudTh>數量</MudTh>
                        <MudTh>小計</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.ProductName</MudTd>
                        <MudTd>@context.UnitPrice.ToString("N0")</MudTd>
                        <MudTd>@context.Quantity</MudTd>
                        <MudTd>@context.Subtotal.ToString("N0")</MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                           OnClick="@(() => RemoveFromCart(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="4">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">結帳</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.h3" Align="Align.Center" Color="Color.Primary" Class="mb-4">
                    $@_cartItems.Sum(x => x.Subtotal).ToString("N0")
                </MudText>

                <MudSelect T="int?" @bind-Value="_selectedCustomerId" Label="會員" Clearable="true" Variant="Variant.Outlined" Class="mb-4">
                    @foreach (var customer in _customers)
                    {
                        <MudSelectItem Value="@((int?)customer.Id)">@customer.Name (@customer.Phone)</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect T="int" @bind-Value="_selectedWarehouseId" Label="出貨倉庫" Variant="Variant.Outlined" Class="mb-4">
                    @foreach (var wh in _warehouses)
                    {
                        <MudSelectItem Value="@wh.Id">@wh.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect T="int" @bind-Value="_selectedPaymentMethodId" Label="付款方式" Variant="Variant.Outlined" Class="mb-4">
                    @foreach (var pm in _paymentMethods)
                    {
                        <MudSelectItem Value="@pm.Id">@pm.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Size="Size.Large"
                           OnClick="Checkout" Disabled="@(!_cartItems.Any())">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCartCheckout" Class="mr-2" />
                    結帳
                </MudButton>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private Product? _selectedProduct;
    private int _quantity = 1;
    private List<CartItem> _cartItems = new();
    private List<Customer> _customers = new();
    private List<PaymentMethod> _paymentMethods = new();
    private List<Warehouse> _warehouses = new();
    private int? _selectedCustomerId;
    private int _selectedPaymentMethodId;
    private int _selectedWarehouseId;
    private int _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        // 取得目前使用者
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        _currentUserId = user?.Id ?? 0;

        // 使用服務層取得資料
        _customers = await CustomerService.GetActiveAsync();
        _paymentMethods = await DbContext.PaymentMethods.Where(p => p.IsActive).OrderBy(p => p.SortOrder).ToListAsync();
        _warehouses = await DbContext.Warehouses.Where(w => w.IsActive).OrderBy(w => w.Name).ToListAsync();

        if (_paymentMethods.Any())
        {
            _selectedPaymentMethodId = _paymentMethods.First().Id;
        }
        if (_warehouses.Any())
        {
            _selectedWarehouseId = _warehouses.First().Id;
        }
    }

    private async Task<IEnumerable<Product>> SearchProducts(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Enumerable.Empty<Product>();

        // 使用服務層搜尋商品
        return await ProductService.SearchForPosAsync(value, 10);
    }

    private void AddToCart()
    {
        if (_selectedProduct == null) return;

        var existing = _cartItems.FirstOrDefault(x => x.ProductId == _selectedProduct.Id);
        if (existing != null)
        {
            existing.Quantity += _quantity;
        }
        else
        {
            _cartItems.Add(new CartItem
            {
                ProductId = _selectedProduct.Id,
                ProductName = _selectedProduct.Name,
                UnitPrice = _selectedProduct.SellingPrice,
                CostPrice = _selectedProduct.CostPrice,
                Quantity = _quantity
            });
        }

        _selectedProduct = null;
        _quantity = 1;
    }

    private void RemoveFromCart(CartItem item)
    {
        _cartItems.Remove(item);
    }

    private async Task Checkout()
    {
        if (!_cartItems.Any())
        {
            Snackbar.Add("購物車是空的", Severity.Warning);
            return;
        }

        if (_selectedWarehouseId == 0)
        {
            Snackbar.Add("請選擇出貨倉庫", Severity.Warning);
            return;
        }

        try
        {
            // 建立訂單並扣減庫存 - 使用服務層
            var order = new Order
            {
                CustomerId = _selectedCustomerId,
                StoreId = 1, // 預設門市
                Status = OrderStatus.Completed,
                Items = _cartItems.Select(x => new OrderItem
                {
                    ProductId = x.ProductId,
                    Quantity = x.Quantity,
                    UnitPrice = x.UnitPrice,
                    CostPrice = x.CostPrice
                }).ToList(),
                Payments = new List<OrderPayment>
                {
                    new OrderPayment
                    {
                        PaymentMethodId = _selectedPaymentMethodId,
                        Amount = _cartItems.Sum(x => x.Subtotal)
                    }
                }
            };

            // 使用服務層建立訂單並扣減庫存
            await OrderService.CreateWithInventoryDeductionAsync(order, _selectedWarehouseId, _currentUserId);

            // 更新客戶累積消費
            if (_selectedCustomerId.HasValue)
            {
                await CustomerService.UpdateTotalSpentAsync(_selectedCustomerId.Value, order.TotalAmount);
            }

            _cartItems.Clear();
            _selectedCustomerId = null;
            Snackbar.Add($"結帳成功！訂單編號：{order.OrderNumber}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"結帳失敗：{ex.Message}", Severity.Error);
        }
    }

    private class CartItem
    {
        public int ProductId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public decimal UnitPrice { get; set; }
        public decimal CostPrice { get; set; }
        public int Quantity { get; set; }
        public decimal Subtotal => UnitPrice * Quantity;
    }
}
