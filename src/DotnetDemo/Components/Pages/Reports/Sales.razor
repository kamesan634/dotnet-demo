@page "/reports/sales"
@attribute [Authorize]
@using DotnetDemo.Services.Interfaces
@inject IReportService ReportService

<PageTitle>銷售報表 - 零售管理系統</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">銷售報表</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudDateRangePicker Label="日期範圍" @bind-DateRange="_dateRange" Variant="Variant.Outlined" />
    </MudItem>
    <MudItem xs="12" md="6" Class="d-flex align-end">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadReportAsync"
                   StartIcon="@Icons.Material.Filled.Search">查詢</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="ml-2"
                   StartIcon="@Icons.Material.Filled.Download">匯出 Excel</MudButton>
    </MudItem>
</MudGrid>

<MudCard Class="mt-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">銷售日報</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudTable Items="@_dailyReports" Dense="true" Hover="true" Loading="@_loading">
            <HeaderContent>
                <MudTh>日期</MudTh>
                <MudTh>訂單數</MudTh>
                <MudTh>總金額</MudTh>
                <MudTh>折扣金額</MudTh>
                <MudTh>淨額</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Date.ToString("yyyy-MM-dd")</MudTd>
                <MudTd>@context.OrderCount</MudTd>
                <MudTd>$@context.TotalAmount.ToString("N0")</MudTd>
                <MudTd>$@context.DiscountAmount.ToString("N0")</MudTd>
                <MudTd>$@context.NetAmount.ToString("N0")</MudTd>
            </RowTemplate>
            <FooterContent>
                <MudTd colspan="2"><strong>合計</strong></MudTd>
                <MudTd><strong>$@_dailyReports.Sum(x => x.TotalAmount).ToString("N0")</strong></MudTd>
                <MudTd><strong>$@_dailyReports.Sum(x => x.DiscountAmount).ToString("N0")</strong></MudTd>
                <MudTd><strong>$@_dailyReports.Sum(x => x.NetAmount).ToString("N0")</strong></MudTd>
            </FooterContent>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    private DateRange _dateRange = new(DateTime.Today.AddDays(-30), DateTime.Today);
    private List<SalesDailyReport> _dailyReports = new();
    private bool _loading;

    protected override async Task OnInitializedAsync()
    {
        await LoadReportAsync();
    }

    private async Task LoadReportAsync()
    {
        _loading = true;

        var startDate = _dateRange.Start ?? DateTime.Today.AddDays(-30);
        var endDate = _dateRange.End ?? DateTime.Today;

        _dailyReports = await ReportService.GetSalesDailyReportAsync(startDate, endDate);

        _loading = false;
    }
}
