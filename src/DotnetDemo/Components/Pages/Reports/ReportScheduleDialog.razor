@using Microsoft.AspNetCore.Identity
@using DotnetDemo.Services.Interfaces
@inject IReportScheduleService ReportScheduleService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@(IsNew ? "新增報表排程" : "編輯報表排程")</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="_isValid">
            <MudTextField @bind-Value="Schedule.Name" Label="排程名稱" Required="true"
                          RequiredError="請輸入名稱" Variant="Variant.Outlined" Class="mb-3" />
            <MudSelect T="string" @bind-Value="Schedule.ReportType" Label="報表類型" Required="true"
                       RequiredError="請選擇報表類型" Variant="Variant.Outlined" Class="mb-3">
                <MudSelectItem Value="@("Sales")">銷售報表</MudSelectItem>
                <MudSelectItem Value="@("Inventory")">庫存報表</MudSelectItem>
                <MudSelectItem Value="@("Purchasing")">採購報表</MudSelectItem>
                <MudSelectItem Value="@("Profit")">利潤報表</MudSelectItem>
            </MudSelect>
            <MudSelect T="ReportFrequency" @bind-Value="Schedule.Frequency" Label="執行頻率"
                       Variant="Variant.Outlined" Class="mb-3">
                <MudSelectItem Value="ReportFrequency.Daily">每日</MudSelectItem>
                <MudSelectItem Value="ReportFrequency.Weekly">每週</MudSelectItem>
                <MudSelectItem Value="ReportFrequency.Monthly">每月</MudSelectItem>
            </MudSelect>
            <MudTimePicker @bind-Time="_executionTime" Label="執行時間" Variant="Variant.Outlined" Class="mb-3" />
            @if (Schedule.Frequency == ReportFrequency.Weekly)
            {
                <MudSelect T="int?" @bind-Value="Schedule.DayOfWeek" Label="週幾執行" Variant="Variant.Outlined" Class="mb-3">
                    <MudSelectItem T="int?" Value="1">週一</MudSelectItem>
                    <MudSelectItem T="int?" Value="2">週二</MudSelectItem>
                    <MudSelectItem T="int?" Value="3">週三</MudSelectItem>
                    <MudSelectItem T="int?" Value="4">週四</MudSelectItem>
                    <MudSelectItem T="int?" Value="5">週五</MudSelectItem>
                    <MudSelectItem T="int?" Value="6">週六</MudSelectItem>
                    <MudSelectItem T="int?" Value="7">週日</MudSelectItem>
                </MudSelect>
            }
            @if (Schedule.Frequency == ReportFrequency.Monthly)
            {
                <MudNumericField @bind-Value="Schedule.DayOfMonth" Label="每月幾號" Min="1" Max="31"
                                 Variant="Variant.Outlined" Class="mb-3" />
            }
            <MudTextField @bind-Value="Schedule.Recipients" Label="收件人 Email" Required="true"
                          RequiredError="請輸入收件人" HelperText="多個收件人請用逗號分隔"
                          Variant="Variant.Outlined" Class="mb-3" />
            <MudSelect T="string" @bind-Value="Schedule.ExportFormat" Label="匯出格式"
                       Variant="Variant.Outlined" Class="mb-3">
                <MudSelectItem Value="@("Excel")">Excel</MudSelectItem>
                <MudSelectItem Value="@("PDF")">PDF</MudSelectItem>
                <MudSelectItem Value="@("CSV")">CSV</MudSelectItem>
            </MudSelect>
            <MudCheckBox T="bool" @bind-Value="Schedule.IsActive" Label="啟用" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">取消</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Disabled="@(!_isValid)">
            @(IsNew ? "新增" : "儲存")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public ReportSchedule Schedule { get; set; } = new();

    [Parameter]
    public bool IsNew { get; set; }

    private MudForm _form = null!;
    private bool _isValid;
    private TimeSpan? _executionTime;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(Schedule.ExecutionTime))
        {
            var parts = Schedule.ExecutionTime.Split(':');
            if (parts.Length >= 2 && int.TryParse(parts[0], out var hour) && int.TryParse(parts[1], out var minute))
            {
                _executionTime = new TimeSpan(hour, minute, 0);
            }
        }
        else
        {
            _executionTime = new TimeSpan(8, 0, 0);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        await _form.Validate();
        if (!_isValid) return;

        Schedule.ExecutionTime = _executionTime?.ToString(@"hh\:mm") ?? "08:00";

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        if (IsNew)
        {
            await ReportScheduleService.CreateAsync(Schedule, user?.Id ?? 0);
        }
        else
        {
            await ReportScheduleService.UpdateAsync(Schedule);
        }

        MudDialog.Close(DialogResult.Ok(Schedule));
    }
}
