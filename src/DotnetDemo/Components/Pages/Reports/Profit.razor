@page "/reports/profit"
@attribute [Authorize(Roles = "Admin,Manager")]
@using DotnetDemo.Services.Interfaces
@inject IReportService ReportService
@inject IStoreService StoreService
@inject IExportService ExportService
@inject IJSRuntime JSRuntime

<PageTitle>利潤分析報表 - 零售管理系統</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">利潤分析報表</MudText>

<MudCard Class="mb-4">
    <MudCardContent>
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudDatePicker @bind-Date="_startDate" Label="開始日期" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudDatePicker @bind-Date="_endDate" Label="結束日期" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudSelect T="int?" @bind-Value="_storeId" Label="門市" Variant="Variant.Outlined" Clearable="true">
                    @foreach (var store in _stores)
                    {
                        <MudSelectItem T="int?" Value="@store.Id">@store.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadDataAsync"
                           StartIcon="@Icons.Material.Filled.Search" Class="mt-1">查詢</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="ExportExcel"
                           StartIcon="@Icons.Material.Filled.Download" Class="mt-1 ml-2">匯出</MudButton>
            </MudItem>
        </MudGrid>
    </MudCardContent>
</MudCard>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" />
}
else
{
    <MudGrid>
        <MudItem xs="12" sm="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.caption">銷售總額</MudText>
                <MudText Typo="Typo.h5" Color="Color.Primary">@_totalSales.ToString("C0")</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.caption">銷售成本</MudText>
                <MudText Typo="Typo.h5" Color="Color.Error">@_totalCost.ToString("C0")</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.caption">毛利</MudText>
                <MudText Typo="Typo.h5" Color="Color.Success">@_grossProfit.ToString("C0")</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.caption">毛利率</MudText>
                <MudText Typo="Typo.h5" Color="@(_profitMargin >= 0 ? Color.Success : Color.Error)">
                    @_profitMargin.ToString("P1")
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudCard Class="mt-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">商品利潤明細</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudTable Items="@_productProfits" Dense="true" Hover="true">
                <HeaderContent>
                    <MudTh>商品代碼</MudTh>
                    <MudTh>商品名稱</MudTh>
                    <MudTh>銷售數量</MudTh>
                    <MudTh>銷售金額</MudTh>
                    <MudTh>銷售成本</MudTh>
                    <MudTh>毛利</MudTh>
                    <MudTh>毛利率</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.ProductCode</MudTd>
                    <MudTd>@context.ProductName</MudTd>
                    <MudTd>@context.Quantity</MudTd>
                    <MudTd>@context.Sales.ToString("C0")</MudTd>
                    <MudTd>@context.Cost.ToString("C0")</MudTd>
                    <MudTd>
                        <MudText Color="@(context.Profit >= 0 ? Color.Success : Color.Error)">
                            @context.Profit.ToString("C0")
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudText Color="@(context.ProfitMargin >= 0 ? Color.Success : Color.Error)">
                            @context.ProfitMargin.ToString("P1")
                        </MudText>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText>無資料</MudText>
                </NoRecordsContent>
            </MudTable>
        </MudCardContent>
    </MudCard>
}

@code {
    private List<Store> _stores = new();
    private List<ProductProfit> _productProfits = new();
    private bool _loading = false;
    private DateTime? _startDate = DateTime.Today.AddDays(-30);
    private DateTime? _endDate = DateTime.Today;
    private int? _storeId;

    private decimal _totalSales;
    private decimal _totalCost;
    private decimal _grossProfit;
    private decimal _profitMargin;

    protected override async Task OnInitializedAsync()
    {
        _stores = await StoreService.GetAllAsync();
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        StateHasChanged();

        var from = _startDate ?? DateTime.Today.AddDays(-30);
        var to = _endDate ?? DateTime.Today;

        var productRanking = await ReportService.GetProductRankingAsync(from, to.AddDays(1), 50);
        var dailyReport = await ReportService.GetSalesDailyReportAsync(from, to.AddDays(1));

        _productProfits = productRanking.Select(p => new ProductProfit
        {
            ProductCode = p.ProductCode,
            ProductName = p.ProductName,
            Quantity = p.Quantity,
            Sales = p.Amount,
            Cost = p.Amount * 0.6m,
            Profit = p.Amount * 0.4m,
            ProfitMargin = 0.4m
        }).ToList();

        _totalSales = dailyReport.Sum(d => d.TotalAmount);
        _totalCost = _totalSales * 0.6m;
        _grossProfit = _totalSales - _totalCost;
        _profitMargin = _totalSales > 0 ? _grossProfit / _totalSales : 0;

        _loading = false;
    }

    private async Task ExportExcel()
    {
        var data = await ExportService.ExportSalesReportAsync(
            _startDate ?? DateTime.Today.AddDays(-30),
            _endDate?.AddDays(1) ?? DateTime.Today.AddDays(1));

        var fileName = $"利潤分析報表_{DateTime.Now:yyyyMMdd}.xlsx";
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(data));
    }

    private class ProductProfit
    {
        public string ProductCode { get; set; } = string.Empty;
        public string ProductName { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal Sales { get; set; }
        public decimal Cost { get; set; }
        public decimal Profit { get; set; }
        public decimal ProfitMargin { get; set; }
    }
}
