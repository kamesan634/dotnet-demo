@using Microsoft.AspNetCore.Identity
@using DotnetDemo.Services.Interfaces
@inject IStockTransferService StockTransferService
@inject IWarehouseService WarehouseService
@inject IProductService ProductService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudSelect T="int" @bind-Value="_fromWarehouseId" Label="調出倉庫" Required="true"
                           RequiredError="請選擇調出倉庫">
                    @foreach (var warehouse in _warehouses)
                    {
                        <MudSelectItem Value="@warehouse.Id">@warehouse.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudSelect T="int" @bind-Value="_toWarehouseId" Label="調入倉庫" Required="true"
                           RequiredError="請選擇調入倉庫">
                    @foreach (var warehouse in _warehouses.Where(w => w.Id != _fromWarehouseId))
                    {
                        <MudSelectItem Value="@warehouse.Id">@warehouse.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_notes" Label="備註" Lines="2" />
            </MudItem>
            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.subtitle1" Class="mb-2">調撥項目</MudText>
                <MudButton Variant="Variant.Outlined" Size="Size.Small" StartIcon="@Icons.Material.Filled.Add"
                           OnClick="AddItem">新增項目</MudButton>
            </MudItem>
            @for (int i = 0; i < _items.Count; i++)
            {
                var index = i;
                <MudItem xs="12" sm="6">
                    <MudSelect T="int" @bind-Value="_items[index].ProductId" Label="商品"
                               Required="true" RequiredError="請選擇商品">
                        @foreach (var product in _products)
                        {
                            <MudSelectItem Value="@product.Id">@product.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudNumericField T="int" @bind-Value="_items[index].Quantity" Label="調撥數量" Min="1" />
                </MudItem>
                <MudItem xs="12" sm="2">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                   OnClick="@(() => RemoveItem(index))" />
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">取消</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveAsync"
                   Disabled="@(!_items.Any() || _fromWarehouseId == 0 || _toWarehouseId == 0)">儲存</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = null!;

    private List<Warehouse> _warehouses = new();
    private List<Product> _products = new();
    private int _fromWarehouseId;
    private int _toWarehouseId;
    private string? _notes;
    private List<TransferItem> _items = new();

    protected override async Task OnInitializedAsync()
    {
        _warehouses = await WarehouseService.GetActiveAsync();
        _products = await ProductService.SearchAsync(null, null, true);
    }

    private void AddItem()
    {
        _items.Add(new TransferItem { Quantity = 1 });
    }

    private void RemoveItem(int index)
    {
        _items.RemoveAt(index);
    }

    private async Task SaveAsync()
    {
        if (_fromWarehouseId == 0 || _toWarehouseId == 0 || !_items.Any())
        {
            Snackbar.Add("請填寫完整資料", Severity.Warning);
            return;
        }

        if (_fromWarehouseId == _toWarehouseId)
        {
            Snackbar.Add("調出倉庫和調入倉庫不能相同", Severity.Warning);
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        var userId = user?.Id ?? 0;

        var transfer = new StockTransfer
        {
            FromWarehouseId = _fromWarehouseId,
            ToWarehouseId = _toWarehouseId,
            Notes = _notes,
            Items = _items.Select(i => new StockTransferItem
            {
                ProductId = i.ProductId,
                Quantity = i.Quantity
            }).ToList()
        };

        try
        {
            await StockTransferService.CreateAsync(transfer, userId);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"儲存失敗：{ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private class TransferItem
    {
        public int ProductId { get; set; }
        public int Quantity { get; set; }
    }
}
