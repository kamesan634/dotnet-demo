@page "/login"
@layout LoginLayout
@using Microsoft.AspNetCore.Identity
@using DotnetDemo.Models.Entities
@using Microsoft.AspNetCore.Authentication
@using System.Security.Claims
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject ILogger<Login> Logger
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>登入 - 零售管理系統</PageTitle>

<MudGrid Justify="Justify.Center" Class="mt-16">
    <MudItem xs="12" sm="8" md="5" lg="4">
        <MudCard Elevation="4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Large" Class="mr-2" />
                        零售管理系統
                    </MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <EditForm Model="@_model" OnValidSubmit="HandleLogin" FormName="login">
                    <DataAnnotationsValidator />

                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
                    }

                    <MudTextField @bind-Value="_model.UserName" Label="帳號" Variant="Variant.Outlined"
                                  Required="true" RequiredError="請輸入帳號"
                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person"
                                  Class="mb-4" />

                    <MudTextField @bind-Value="_model.Password" Label="密碼" Variant="Variant.Outlined"
                                  InputType="@_passwordInputType"
                                  Required="true" RequiredError="請輸入密碼"
                                  Adornment="Adornment.End" AdornmentIcon="@_passwordIcon"
                                  OnAdornmentClick="TogglePasswordVisibility"
                                  Class="mb-4" />

                    <MudCheckBox T="bool" @bind-Value="_model.RememberMe" Label="記住我" Color="Color.Primary" Class="mb-4" />

                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
                               FullWidth="true" Size="Size.Large" Disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        登入
                    </MudButton>
                </EditForm>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
                    測試帳號: admin / password123
                </MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private LoginModel _model = new();
    private string? _errorMessage;
    private bool _isLoading;
    private bool _showPassword;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
        _passwordInputType = _showPassword ? InputType.Text : InputType.Password;
        _passwordIcon = _showPassword ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private async Task HandleLogin()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var user = await UserManager.FindByNameAsync(_model.UserName);

            if (user == null || !user.IsActive)
            {
                _errorMessage = "帳號或密碼錯誤";
                return;
            }

            var passwordValid = await UserManager.CheckPasswordAsync(user, _model.Password);
            if (!passwordValid)
            {
                _errorMessage = "帳號或密碼錯誤";
                return;
            }

            // 更新最後登入時間
            user.LastLoginAt = DateTime.UtcNow;
            await UserManager.UpdateAsync(user);

            Logger.LogInformation("使用者 {UserName} 登入成功", _model.UserName);

            // 重導向到登入處理端點
            Navigation.NavigateTo($"/api/auth/login?userName={Uri.EscapeDataString(_model.UserName)}&rememberMe={_model.RememberMe}", forceLoad: true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "登入失敗");
            _errorMessage = "登入失敗，請稍後再試";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private class LoginModel
    {
        public string UserName { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public bool RememberMe { get; set; }
    }
}
